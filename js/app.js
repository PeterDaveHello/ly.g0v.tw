function matchMotions(e,t){var n,r,o,i;for(n=moment(t.date).format("YYYY-MM-DD"),r=0,o=e.length;o>r;++r)if(i=e[r],i.date===n&&i.description==="決定："+t.resolution.replace(/\(\S+\s+\S+\)/,""))return i.links=t.links,void 0;return e.push({date:n,description:t.resolution,links:t.links})}function buildSteps(e){var t,n,r,o,i,a,s,l,c,u;for(t=[{name:"proposal",sub:!1,description:"提案",status:{step:"passed",state:"not-yet",icon:""},detail:[]},{name:"first-reading",sub:!1,description:"一讀",status:{step:"not-yet",state:"not-yet",icon:""},detail:[]},{name:"committee",sub:!1,description:"委員會",status:{step:"not-yet",state:"not-yet",icon:""},detail:[]},{name:"second-reading",sub:!1,description:"二讀",status:{step:"not-yet not-implemented no-hover",state:"not-yet",icon:""},detail:[]},{name:"third-reading",sub:!1,description:"三讀",status:{step:"not-yet not-implemented no-hover",state:"not-yet",icon:"check"},date:"",detail:[]},{name:"announced",sub:!1,description:"頒佈",status:{step:"not-yet not-implemented no-hover",state:"not-yet",icon:"check"},date:"",detail:[]},{name:"implemented",sub:!1,description:"生效",status:{step:"not-yet not-implemented no-hover",state:"hidden",icon:""},date:"",detail:[]}],n=0,r=e.length;r>n;++n)switch(o=n,i=e[n],0===o&&(t[0].date=i.dates[0].date),a=[i.status],!1){case"prioritized"!==a[0]:s={name:"proposal",description:i.resolution,status:{step:"passed",state:"passed",icon:"star"},date:i.dates[0].date},l=t[0].status,"not-yet"===l.state&&(l.state="passed"),l.icon||(l.icon="check"),t[1].status=s.status,t[1].detail.push(s),t[2].status={icon:"star",state:"passed"};break;case"rejected"!==a[0]:s={name:"proposal",description:i.resolution,status:{step:"returned",state:"returned",icon:"exclamation"},date:i.dates[0].date},t[0].detail.push(s),c=t[0].status,c.icon="exclamation",c.state="returned";break;case"committee"!==a[0]:s={name:"scheduled",description:i.resolution,status:{step:"passed",state:"passed",icon:"check"},date:i.dates[0].date},t[1].date=i.dates[0].date,t[1].status=s.status,t[1].detail.push(s),u=t[0].status,"not-yet"===u.state&&(u.state="passed"),u.icon||(u.icon="check"),t[0].detail.push(s)}return t}function deepEq$(e,t,n){function r(e,t,i){var s,l,c,u,d,f,p,g;if(null==e||null==t)return e===t;if(e.__placeholder__||t.__placeholder__)return!0;if(e===t)return 0!==e||1/e==1/t;if(s=o.call(e),o.call(t)!=s)return!1;switch(s){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(l=i.length;l--;)if(i[l]==e)return!0;if(i.push(e),c=0,u=!0,"[object Array]"==s){if(d=e.length,f=t.length,first){switch(n){case"===":u=d===f;break;case"<==":u=f>=d;break;case"<<=":u=f>d}c=d,first=!1}else u=d===f,c=d;if(u)for(;c--&&(u=c in e==c in t&&r(e[c],t[c],i)););}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(p in e)if(a(e,p)&&(c++,!(u=a(t,p)&&r(e[p],t[p],i))))break;if(u){g=0;for(p in t)a(t,p)&&++g;first?u="<<="===n?g>c:"<=="===n?g>=c:c===g:(first=!1,u=c===g)}}return i.pop(),u}var o={}.toString,i={}.hasOwnProperty,a=function(e,t){return i.call(e,t)};return first=!0,r(e,t,[])}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function curry$(e,t){var n,r=function(o){return e.length>1?function(){var i=o?o.concat():[];return n=t?n||this:this,i.push.apply(i,arguments)<e.length&&arguments.length?r.call(n,i):e.apply(n,i)}:e};return r()}function deepEq$(e,t,n){function r(e,t,i){var s,l,c,u,d,f,p,g;if(null==e||null==t)return e===t;if(e.__placeholder__||t.__placeholder__)return!0;if(e===t)return 0!==e||1/e==1/t;if(s=o.call(e),o.call(t)!=s)return!1;switch(s){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(l=i.length;l--;)if(i[l]==e)return!0;if(i.push(e),c=0,u=!0,"[object Array]"==s){if(d=e.length,f=t.length,first){switch(n){case"===":u=d===f;break;case"<==":u=f>=d;break;case"<<=":u=f>d}c=d,first=!1}else u=d===f,c=d;if(u)for(;c--&&(u=c in e==c in t&&r(e[c],t[c],i)););}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(p in e)if(a(e,p)&&(c++,!(u=a(t,p)&&r(e[p],t[p],i))))break;if(u){g=0;for(p in t)a(t,p)&&++g;first?u="<<="===n?g>c:"<=="===n?g>=c:c===g:(first=!1,u=c===g)}}return i.pop(),u}var o={}.toString,i={}.hasOwnProperty,a=function(e,t){return i.call(e,t)};return first=!0,r(e,t,[])}function deepEq$(e,t,n){function r(e,t,i){var s,l,c,u,d,f,p,g;if(null==e||null==t)return e===t;if(e.__placeholder__||t.__placeholder__)return!0;if(e===t)return 0!==e||1/e==1/t;if(s=o.call(e),o.call(t)!=s)return!1;switch(s){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(l=i.length;l--;)if(i[l]==e)return!0;if(i.push(e),c=0,u=!0,"[object Array]"==s){if(d=e.length,f=t.length,first){switch(n){case"===":u=d===f;break;case"<==":u=f>=d;break;case"<<=":u=f>d}c=d,first=!1}else u=d===f,c=d;if(u)for(;c--&&(u=c in e==c in t&&r(e[c],t[c],i)););}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(p in e)if(a(e,p)&&(c++,!(u=a(t,p)&&r(e[p],t[p],i))))break;if(u){g=0;for(p in t)a(t,p)&&++g;first?u="<<="===n?g>c:"<=="===n?g>=c:c===g:(first=!1,u=c===g)}}return i.pop(),u}var o={}.toString,i={}.hasOwnProperty,a=function(e,t){return i.call(e,t)};return first=!0,r(e,t,[])}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function curry$(e,t){var n,r=function(o){return e.length>1?function(){var i=o?o.concat():[];return n=t?n||this:this,i.push.apply(i,arguments)<e.length&&arguments.length?r.call(n,i):e.apply(n,i)}:e};return r()}function getVideosByCut(e,t,n){return e.get("sittings/"+t+"/videos").success(function(e){function t(e){var t;return(t=+moment(e.time))>+d&&f>=t}var r,o,i,a,s,l,c,u,d,f,p,g,h,m;for(o=[],i=0,a=e.length;a>i;++i)s=e[i],"whole"===s.firm&&o.push((s.first_frame=moment(null!=(l=s.first_frame_timestamp)?l:s.time),s));for(r=o,o=[],i=0,a=e.length;a>i;++i)s=e[i],"whole"!==s.firm&&o.push({time:s.time,mly:replace$.call(s.speaker,/\s*委員/,""),length:s.length,thumb:s.thumb});for(c=o,i=0,a=r.length;a>i;++i){for(u=r[i],d=u.first_frame,f=d+1e3*u.length,p=c.filter(t),g=0,h=p.length;h>g;++g)m=p[g],m.offset=moment(m.time)-d;u.speakers=p}return n(r)})}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;r>++n;)if(e===t[n]&&n in t)return!0;return!1}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;r>++n;)if(e===t[n]&&n in t)return!0;return!1}(function(){"use strict";var e="undefined"!=typeof window?window:global;if("function"!=typeof e.require){var t={},n={},r=function(e,t){return{}.hasOwnProperty.call(e,t)},o=function(e,t){var n,r,o=[];n=/^\.\.?(\/|$)/.test(t)?[e,t].join("/").split("/"):t.split("/");for(var i=0,a=n.length;a>i;i++)r=n[i],".."===r?o.pop():"."!==r&&""!==r&&o.push(r);return o.join("/")},i=function(e){return e.split("/").slice(0,-1).join("/")},a=function(t){return function(n){var r=i(t),a=o(r,n);return e.require(a)}},s=function(e,t){var r={id:e,exports:{}};t(r.exports,a(e),r);var o=n[e]=r.exports;return o},l=function(e){var i=o(e,".");if(r(n,i))return n[i];if(r(t,i))return s(i,t[i]);var a=o(i,"./index");if(r(n,a))return n[a];if(r(t,a))return s(a,t[a]);throw Error('Cannot find module "'+e+'"')},c=function(e,n){if("object"==typeof e)for(var o in e)r(e,o)&&(t[o]=e[o]);else t[e]=n};e.require=l,e.require.define=c,e.require.register=c,e.require.brunch=!0}})(),angular.module("ly.g0v.tw",["ngGrid","app.controllers","ly.g0v.tw.controllers","app.directives","app.filters","app.services","partials","ui.state","utils","monospaced.qrcode"]).config(["$stateProvider","$urlRouterProvider","$locationProvider"].concat(function(e,t,n){return e.state("motions",{url:"/motions",templateUrl:"/partials/motions.html",controller:"LYMotions"}).state("motions.sitting",{url:"/{session}/{sitting}"}).state("bills",{url:"/bills/{billId}",templateUrl:"/partials/bills.html",resolve:{_init:["LYService"].concat(function(e){return e.init()})},controller:"LYBills"}).state("calendar",{url:"/calendar",templateUrl:"/partials/calendar.html",resolve:{_init:["LYService"].concat(function(e){return e.init()})},controller:"LYCalendar"}).state("calendar.period",{url:"/{period}"}).state("sittings",{url:"/sittings",templateUrl:"/partials/sittings.html",controller:"LYSittings",resolve:{_init:["LYService"].concat(function(e){return e.init()})}}).state("sittings.detail",{url:"/{sitting}"}).state("sittings.detail.video",{url:"/video"}).state("debates",{url:"/debates",templateUrl:"/partials/debates.html",resolve:{_init:["LYService"].concat(function(e){return e.init()})}}).state("sitting",{url:"/sitting",templateUrl:"/partials/sitting.html",controller:"LYSitting"}).state("search",{url:"/search",templateUrl:"/partials/search.html",controller:"LYSearch"}).state("search.target",{url:"/{keyword}"}).state("about",{url:"/about",templateUrl:"/partials/about.html",controller:"About"}),t.otherwise("/calendar"),n.html5Mode(!0)})).run(["$rootScope","$state","$stateParams","$location","$anchorScroll"].concat(function(e,t,n,r){return e.$state=t,e.$stateParam=n,e.go=function(e){return r.path(e)},e.config_build=window.global.config.BUILD,e.$on("$stateChangeSuccess",function(e,t){var n;return n=t.name,"undefined"!=typeof window&&null!==window?"function"==typeof window.ga?window.ga("send","pageview",{page:r.$$url,title:n}):void 0:void 0}),window.onYouTubeIframeAPIReady=function(){return e.$broadcast("youtube-ready")}}));var buildAvatar;buildAvatar=function(e,t,n,r,o){var i,a,s,l,c,u,d,f,p,g;return i=n.w,a=n.h,s=n.x,l=n.y,c=n.margin,u=1e3*((d=t.time)?moment(d).unix():-28800),f=d3.svg.axis().scale(s).orient("bottom").tickFormat(function(e){return moment(1e3*((e+u/1e3)%86400)).format("HH:mm:ss")}),p=d3.select(e.children()[0]).attr("width",i).attr("height",a).on("click",function(){var e;return e=s.invert(d3.mouse(this)[0]-c.left),$(p).find(".location-marker").attr("transform","translate("+e+" "+c.top+")"),t.cb(e)}).append("g").attr("transform","translate("+c.left+" "+c.top+")"),p.append("g").attr("class","x axis").attr("transform","translate(0,"+(a-c.bottom)+")").call(f),p.append("text").attr("class","x-legend").text(function(){return moment(t.time).format("YYYY/MM/DD")}).attr("x",function(){return(i+c.left-c.right)/2}).attr("y",function(){return a-c.bottom}).attr("dy",30).attr("stroke","black").attr("text-anchor","middle"),p.append("path").attr("class","location-marker").attr("d","M0 0L0,"+(a-c.bottom-c.top)).attr("stroke","#f00").attr("stroke-width","2px").attr("transform",function(){return"translate("+s(t.current)+" 0)"}),g=p.selectAll("g.avatar").data(t.speakers).enter().append("g"),g.each(function(e){return e.color=o.resolvePartyColor(e.mly)}),g.attr("class","avatar"),g.attr("transform",function(e){return"translate("+s(e.offset/1e3)+" 0)"}),g.on("mouseover",function(t){var n,o,i;return n=$("#avatar-tooltip"),n.show(),o=$(this).offset(),o.left-=n.outerWidth()/2,o.top=e.offset().top-n.outerHeight()-5,$("#avatar-tooltip").offset(o),i=""+CryptoJS.MD5("MLY/"+t.mly),n.find("img").attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAAAAAAALAAAAAABAAEAQAICRAEAOw=="),setTimeout(function(){return n.find("img").attr("src","http://avatars.io/50a65bb26e293122b0000073/"+i+"?size=medium")},0),n.find(".name").text(t.mly),n.find("a.btn").on("click",function(){return r.model.cb(t.offset/1e3),$("#avatar-tooltip").hide()})}),g.append("rect").attr("width",function(e){var t;return 12>(t=s(e.length))?12:t-1}).attr("height",12).style("stroke-width","1px").style("stroke",function(e){return e.color}).style("fill",function(e){return e.color}).style("fill-opacity","0.5"),g.append("rect").attr("width",function(e){var t;return 12>(t=s(e.length))?12:t-1}).attr("height",function(){return a-12-c.bottom}).attr("transform","translate(0 12)").style("stroke-width","1px").style("stroke",function(e){return e.color}).style("fill",function(e){return e.color}).style("fill-opacity","0.2"),g.append("image").attr("class","avatar small").attr("transform","translate(1 1)").attr("width",10).attr("height",10).attr("xlink:href",function(e){var t;return t=""+CryptoJS.MD5("MLY/"+e.mly),"http://avatars.io/50a65bb26e293122b0000073/"+t+"?size=small"}).attr("alt",function(e){return e.speaker}),g},angular.module("app.directives",["app.services"]).directive("ngxResize",["$window"].concat(function(e){return function(t){return t.width=e.innerWidth,t.height=e.innerHeight,angular.element(e).bind("resize",function(){return t.$apply(function(){return t.width=e.innerWidth,t.height=e.innerHeight})})}})).directive("ngWaveform",["$compile","LYService"].concat(function(e,t){return{restrict:"E",replace:!0,template:"<div class='wav-group'><svg></svg></div>",scope:{model:"=ngModel"},link:function(e,n,r){var o,i,a,s,l,c,u,d,f,p,g,h;o={top:0,left:30,right:30,bottom:50},i=~~r.width||n.parent().width()-o.left-o.right,a=~~r.height||n.parent().height()-o.top-o.bottom,s=r.innercolor||"#000",l=r.outercolor||"#fff",c=[n.width(),n.height(),null,null],u=c[0],d=c[1],f=c[2],p=c[3],g=h=new Waveform({container:n[0],width:i,height:a,innerColor:s,outerColor:l}),g.canvas.style.marginLeft=o.left+"px",e.$watch("model.current",function(e){return n.find(".location-marker").attr("transform","translate("+("function"==typeof f?f(e):void 0)+" "+o.top+")")}),e.$watch("model",function(r){r&&(f=d3.scale.linear().range([0,u-o.left-o.right]).domain([0,r.wave.length]),p=d3.scale.linear().range([d,0]).domain([0,d3.max(r.wave)]),buildAvatar(n,r,{w:u,h:d,x:f,y:p,margin:o},e,t),r&&h.update({data:r.wave}))})}}})).directive("whenScrolled",function(){return function(e,t,n){var r;return r=t[0],t.bind("scroll",function(){return r.scrollTop+r.offsetHeight>=r.scrollHeight?e.$apply(n.whenScrolled):void 0})}}).directive("detectVisible",["$window","$document"].concat(function(e){return function(t,n,r){var o;if(r.detectVisible)return o=n[0],angular.element(e).bind("scroll",function(){return t.stopDetect?void 0:e.scrollY<o.offsetTop&&e.scrollY+e.innerHeight>o.offsetTop?t.$apply(r.detectVisible):void 0})}})).directive("autoComplete",["$timeout","$state","LYModel"].concat(function(e,t,n){return function(r,o){var i,a,s;return i=o.parent().next(),a={backspace:8,enter:13,escape:27,upArrow:38,downArrow:40},r.currentIndex=-1,s=7,o.on("keydown",function(n){var l,c,u;if(l=n.keyCode,c=r.currentIndex,i.children().size()>0)if(l===a.enter){if(n.preventDefault(),c>=0)return r.searchKeyword=i.children().eq(c).text(),e(function(){return t.transitionTo("search.target",{keyword:r.searchKeyword}),r.searchKeyword="",o.blur(),r.currentIndex=-1},500)}else{if(l===a.upArrow)return i.children().removeClass("active"),u=0>c-1?c:c-1,i.children().eq(u).addClass("active"),r.currentIndex=u,n.preventDefault();if(l===a.downArrow)return i.children().removeClass("active"),u=c+1>=s?c:c+1,i.children().eq(u).addClass("active"),r.currentIndex=u,n.preventDefault()}}),r.$watch("searchKeyword",function(e){return e?n.get("laws",{params:{q:JSON.stringify({name:{$matches:e}}),l:7}}).success(function(e){function t(){return r.searchKeyword="",o.bur()}var n,a,s,l,c,u,d;if(n=e.paging,a=e.entries,a.length>0){for(i.html(""),s=0,l=a.length;l>s;++s)c=a[s],u=angular.element("<a>").attr("href","/search/"+c.name).html(c.name),u.on("click",t),d=angular.element("<div>").addClass("result").append(u),i.append(d);return i.show()}}):i.hide()})}})),angular.module("app.filters",[]).filter("interpolate",["version"].concat(function(e){return function(t){return(t+"").replace(/\%VERSION\%/gm,e)}}));var replace$="".replace;angular.module("app.services",[]).factory({LYService:["$http"].concat(function(e){var t;return t=[],{init:function(){return e.get("/data/mly-8.json").success(function(e){return t=e})},resolveParty:function(e){var n,r;return n=function(){var o,i,a,s,l=[];for(o=0,a=(i=t).length;a>o;++o)s=i[o],n=s.party,r=s.name,r===e&&l.push(n);return l}()[0]},resolvePartyColor:function(e){return{KMT:"#000095",DPP:"#009a00",PFP:"#fe6407"}[this.resolveParty(e)]||"#999"},parseParty:function(e){var t;return t=function(){var t;switch(t=[e],!1){case"中國國民黨"!==t[0]:return"KMT";case"國民黨"!==t[0]:return"KMT";case"民主進步黨"!==t[0]:return"DPP";case"民進黨"!==t[0]:return"DPP";case"台灣團結聯盟"!==t[0]:return"TSU";case"台灣團結聯盟"!==t[0]:return"TSU";case"無黨團結聯盟"!==t[0]:return"NSU";case"親民黨"!==t[0]:return"PFP";case"新黨"!==t[0]:return"NP";case"建國黨"!==t[0]:return"TIP";case"超黨派問政聯盟"!==t[0]:return"CPU";case"民主聯盟"!==t[0]:return"DU";case"新國家陣線"!==t[0]:return"NNA";case!/無(黨籍)?/.test(t[0]):return null;case"其他"!==t[0]:return null;default:return console.error(it)}}()}}})}).service({LYModel:["$q","$http","$timeout"].concat(function(e,t,n){var r,o,i,a;return r=window.global.config.APIENDPOINT+"v0/collections/",o={},i=function(t){var r,i;return r=e.defer(),i=r.promise,i.success=function(e){return i.then(e)},i.error=function(e){return i.then(e)},n(function(){return console.log("useLocalCache"),r.resolve(o[t])}),i},a=function(e,n,r){var i,a,s;return i=t.get(n,r),a=i.success,s=i.error,i.success=function(t){return a(function(n){return console.log("save response to local model"),o[e]=n,t(n)})},i.error=function(e){return s(function(t){return e(t)})},i},{get:function(e,t){var n,s;return n=r+e,s=t?n+JSON.stringify(t):n,s=replace$.call(s,/\"/g,""),o.hasOwnProperty(s)?i(s):a(s,n,t)}}})});var lineBasedDiff,parseArticleHeading,diffentry,split$="".split,slice$=[].slice,replace$="".replace;lineBasedDiff=function(e,t){function n(){switch(g){case 0:return"both";case 1:return"right";case-1:return"left"}}var r,o,i,a,s,l,c,u,d,f,p,g,h,m,v,b,y,w;for(r=new diff_match_patch,r.Diff_Timeout=1,r.Diff_EditCost=4,o=r.diff_main(e,t),r.diff_cleanupSemantic(o),i=function(){return{left:"",right:""}},a=function(e){return"right"!==e},s=function(e){return"left"!==e},l=[i()],c=u=0,d=0,f=o.length;f>d;++d)for(p=o[d],g=p[0],h=p[1],g=n(),m=split$.call(h,"\n"),v=0,b=m.length;b>v;++v)y=v,w=m[v],""!==w&&("both"!==g&&(w="<em>"+w+"</em>"),a(g)&&(l[c].left+=w),s(g)&&(l[u].right+=w)),y!==m.length-1&&(l.push(i()),a(g)&&(c=l.length-1),s(g)&&(u=l.length-1));for(d=0,f=l.length;f>d;++d)w=l[d],w.state=""===w.left&&""!==w.right?"insert":""!==w.left&&""===w.right?"delete":""!==w.left&&""!==w.right?w.left===w.right?"equal":"replace":"empty";return l},parseArticleHeading=function(e){var t,n,r,o;return null!=(t=e.match(/第(.+)之(.+)條/)||e.match(/第(.+)條(?:之(.+))?/))&&(n=t[0],r=slice$.call(t,1)),r?(o=require("zhutil"),r.filter(function(e){return e}).map(o.parseZHNumber).join("-")):void 0},diffentry=function(e,t,n,r,o){return function(i){var a,s,l,c,u,d,f,p,g;return a=e.header,s="string"==typeof i[n]?i[n]:i[n][a[t].replace(/審查會通過條文/,"審查會")],s&&(s=s.replace(/\n/g,"<br><br>\n")),l=i[r]||"",l&&(l=replace$.call(l,/^第(.*?)條(之.*?)?\s+/,""),(c=parseArticleHeading(replace$.call(RegExp.lastMatch,/\s+$/,"")))&&(u="§"+c,d=c)),f=i[t]||i[r]||"",f=replace$.call(f,/^第(.*?)條(之.*?)?\s+/,""),p=parseArticleHeading(replace$.call(RegExp.lastMatch,/\s+$/,"")),u||((f.match(/^（\S+）\n第(.*?)條/)||f.match(/^（\S+第(.*?)條，保留）/))&&(p=parseArticleHeading(replace$.call(RegExp.lastMatch,/\s+$/,""))),f.match(/^(（\S+）\n|)第\S+(章|編)/)?(u=f.replace(/^（\S+）\n/,"").split("　")[0],d=u):(u="§"+(p||""),d=p)),g=lineBasedDiff(l,f),angular.forEach(g,function(e){return e.left=o.trustAsHtml(e.left),e.right=o.trustAsHtml(e.right)}),s=o.trustAsHtml(s),{comment:s,difflines:g,leftItem:u,leftItemAnchor:d,rightItem:p}}},angular.module("app.controllers.bills",[]).controller({LYBills:["$scope","$state","$timeout","LYService","LYModel","$sce","$anchorScroll"].concat(function(e,t,n,r,o,i,a){return e.diffs=[],e.diffstate=function(e,t){switch(!1){case!("left"===e&&"equal"!==t):return"red";case!(deepEq$(t,"replace","===")||deepEq$(t,"empty","===")||deepEq$(t,"insert","===")||deepEq$(t,"delete","===")):return"green";default:return""}},e.difftxt=function(e,t){switch(!1){case!("left"===e&&"equal"!==t):return"現行";case!(deepEq$(t,"replace","===")||deepEq$(t,"empty","===")):return"修正";case!deepEq$(t,"delete","==="):return"刪除";case!deepEq$(t,"insert","==="):return"新增";default:return"相同"}},e.opts={show_date:!0},e.$watch("$state.params.billId",function(){var s;return s=t.params.billId,o.get("bills/"+s).success(function(l){var c,u,d,f,p;if(c=l.committee,t.current.title="ly.g0v.tw - "+(l.bill_ref||l.bill_id)+" - "+l.summary,u=l.bill_ref){if(u!==s&&!/;/.test(u))return t.transitionTo("bills",{billId:l.bill_ref});e.steps=buildSteps(l.motions),/-/.test(l.bill_ref)||(d=require("sprintf"),o.get("ttsmotions",{params:{s:{date:-1},q:JSON.stringify({bill_refs:{$contains:l.bill_ref}})}}).success(function(t){var n,r,i,a,s,c,u,f,p,g,h,m;for(e.ttsmotions=t.entries,n=0,i=(r=e.ttsmotions).length;i>n;++n){a=n,s=r[n],s.resolution=replace$.call(s.resolution,/\(p\.(.*)\)/,""),c=RegExp.$1.split(/(?:[\s,;]*)?(.*?)\s*(\[.*?\])/),u=[];do{if(f=c.slice(0,3),p=f[0],g=f[1],h=f[2],3!==f.length)break;h=JSON.parse(h),"g"===h[0]&&(m=d.apply(null,["%03d%03d%02d"].concat([h[1],h[2],h[3]])),h="http://lis.ly.gov.tw/lgcgi/lypdftxt?"+m+";"+h[4]+";"+h[5]),u.push({text:g,link:h})}while(c.splice(0,3));switch(s.links=u,s.progress){case"提案":case"退回程序":matchMotions(e.steps[0].detail,s);break;case"一讀":matchMotions(e.steps[1].detail,s);break;case"委員會":matchMotions(e.steps[2].detail,s);break;case"二讀":matchMotions(e.steps[3].detail,s);break;case"三讀":matchMotions(e.steps[4].detail,s);break;case"頒佈":matchMotions(e.steps[5].detail,s);break;case"生效":matchMotions(e.steps[6].detail,s)}}return o.get("bills",{params:{q:JSON.stringify({report_of:{$contains:l.bill_id}}),fo:!0}}).success(function(t){var n,r;return e.report=t,e.steps[3].date=t.motions[0].dates[0].date,n=e.steps[3].status,n.step="scheduled",r={name:"committee",description:t.summary,status:/審查決議：「不予審議」/.exec(t.summary)?{step:"red",state:"red",icon:"exclamation"}:{step:"passed",state:"passed",icon:"check"}},e.steps[2].status=r.status,e.steps[2].detail.push(r)})})),o.get("bills/"+s+"/data").success(function(t){var n,r;return e.diff=null!=t?null!=(n=t.content)?n.map(function(e){var t,n,r,o,a;return e.name||(e.name="併案審議"),t=e.header,o=function(){var e,o,i,a=[];for(e=0,i=(o=t).length;i>e;++e)n=e,r=o[e],/^現行/.exec(r)&&a.push(n);return a}()[0],a=function(){var e,o,i,a=[];for(e=0,i=(o=t).length;i>e;++e)n=e,r=o[e],"說明"===r&&a.push(n);return a}()[0],import$({header:e.header,content:e.content,name:e.name},{versions:t.filter(function(e,t){return"說明"!==e&&t!==o}),baseIndex:o,commentIndex:a,diffbase:t[o],diffnew:t[0],diffcontent:e.content.map(diffentry(e,0,a,o,i))})}):void 0:void 0,null!=(n=e.diff)&&n.length&&(r=e.diff.map(function(e){return e.content.length}).reduce(curry$(function(e,t){return e+t}))),e.showSidebar=r>3})}return null!=c&&(c=c.map(function(e){return{abbr:e,name:committees[e]}})),e.summary=l.summary,e.abstract=l.abstract,e.bill_id=l.bill_id,e.bill_ref=l.bill_ref,e.doc=l.doc,p=e,p.committee=c,f=p,f.sponsors=null!=(p=l.sponsors)?p.map(function(e){var t;return t=r.resolveParty(e),{party:t,name:e,avatar:""+CryptoJS.MD5("MLY/"+e)}}):void 0,f.cosponsors=null!=(p=l.cosponsors)?p.map(function(e){var t;return t=r.resolveParty(e),{party:t,name:e,avatar:""+CryptoJS.MD5("MLY/"+e)}}):void 0,f.setDiff=function(e,t){var n,r,o,a,s;return o=function(){var o,i,a,s=[];for(o=0,a=(i=e.header).length;a>o;++o)n=o,r=i[o],r===t&&s.push(n);return s}()[0],a=e.baseIndex,s=e.commentIndex,import$(e,{diffnew:t,diffcontent:e.content.map(diffentry(e,o,s,a,i))})},e.showSub=function(t){return angular.forEach(e.steps,function(e,n){return e.sub=t===n?!e.sub:!1})},n(function(){return a()})})})})}),angular.module("app.controllers.calendar",[]).controller({LYCalendar:["$rootScope","$scope","$state","$http","LYService","LYModel","$sce"].concat(function(e,t,n,r,o,i){function a(e){function t(){var e;return e={start:moment(s).day(0-i),end:moment(s).day(0-i+7)},e.label=e.start.format("YYYY:  MM-DD to "+e.end.format("MM-DD")),e.name=e.start.format("YYYY-MM-DD_"+e.end.format("YYYY-MM-DD")),e}var n,r,o,i;for(r=[],o=0;e>=o;o+=7)i=o,r.push(t());return n=r}var s,l,c,u,d,f,p,g,h;return s=moment().startOf("day"),l=e.committees,t.type="sitting",e.activeTab="calendar",t.weeksOpts=a(49),t.weeksOpts.unshift({start:moment(s).startOf("day").add("days",-1),end:moment(s).startOf("day").add("days",1),label:"今日",name:"today"}),t.$watch("weeks",function(e,r){return t.weeks?e&&r&&!deepEq$(e.label,r.label,"===")?n.transitionTo("calendar.period",{period:t.weeks.name}):void 0:void 0}),t.change=function(e){t.type=e,c()},t.$watch("$state.params.period",function(){return n.params.period?c():(n.transitionTo("calendar.period",{period:t.weeksOpts[0].name}),void 0)}),c=function(){var e,r,o,i,a,s;return d(n.params.period),e=/^calendar.period/.exec(n.current.name)?d(n.params.period):void 0,r=e[0],o=e[1],i=e[2],(!r.isValid()||!o.isValid()||r>o)&&(e=[t.weeksOpts[0].start,t.weeksOpts[0].end,"today"],r=e[0],o=e[1],i=e[2]),e=[r,o].map(function(e){return e.format("YYYY-MM-DD")}),a=e[0],s=e[1],null==i&&(i=a+"_"+s),deepEq$(n.current.name,i,"===")||n.transitionTo("calendar.period",{period:i}),h(t.type,a,s),u(r,o)},u=function(e,n){var r,o;return o=function(){var o,i,a,s=[];for(o=0,a=(i=t.weeksOpts).length;a>o;++o)r=i[o],+r.start===+e&&+r.end===+n&&s.push(r);return s}()[0],t.weeks=o},d=function(e){var n;return/today/.exec(e)||!e?[t.weeksOpts[0].start,t.weeksOpts[0].end,t.weeksOpts[0].name]:(n=e.split("_").map(function(e){return moment(e,"YYYY-MM-DD")}),n.push(e),n)},f=function(e,t){var n;return n=t.date+t.time_start+t.time_end+t.sitting_id,null==e[n]&&(e[n]=t),e[n]=t.id>e[n].id?t:e[n]},p=function(e){var t,n,r,o,i,a;for(t=Object.keys(e).sort(),r=[],o=0,i=t.length;i>o;++o)a=t[o],e[a]&&r.push(e[a]);return n=r},g=function(e,t,n){var r,o,i,a;return r=moment(e).startOf("day"),o=[t,n].map(function(e){return moment(e,"HH:mm:ss")}),i=o[0],a=o[1],+s===+r&&(o=moment())>=i&&a>=o},h=function(e,n,r){return i.get("calendar",{params:{s:JSON.stringify({date:1,time_start:1}),q:JSON.stringify({date:{$gt:n,$lt:r},type:e}),l:1e3}}).success(function(e){var n,r,o,i,a;n=e.paging,r=e.entries,o={},r.map(function(e){var t,n;return e.formatDate=moment(e.date).zone("+00:00").format("MMM Do, YYYY"),e.primaryCommittee=(null!=(t=e.committee)?t[0]:void 0)||"YS",e.onair=g(e.date,e.time_start,e.time_end),null==o[n=e.primaryCommittee]&&(o[n]={}),f(o[e.primaryCommittee],e)}),i={};for(a in o)r=o[a],i[a]=p(o[a]);return t.group=i,t.groupNum=Object.keys(t.group).length})}})}),function(){var e={};e.exports={BUILD:"git-ad543ae",APIENDPOINT:"http://api-beta.ly.g0v.tw/"},window.global||(window.global={}),window.global.config=e.exports}.call(this),angular.module("ly.g0v.tw.controllers",["ng"]).controller({LYDebates:["$rootScope","$scope","$http","LYService","$sce"].concat(function(e,t,n,r,o){var i;return e.activeTab="debates",t.answer=function(e){switch(!1){case!e:return o.trustAsHtml("已答");default:return o.trustAsHtml("未答")}},t.mly=function(e){var t,n,i,a;return t=e.entity,n=t.mly,n[0]?(i=r.resolveParty(n[0]),a=""+CryptoJS.MD5("MLY/"+n[0]),o.trustAsHtml(n[0]+('<img class="avatar small '+i+'" src="http://avatars.io/50a65bb26e293122b0000073/'+a+'?size=small" alt="'+n[0]+'">'))):""},i=function(e,t){return e.length>=t?e:i("0"+e,t)},t.source=function(e){var t,n,r,a,s;return t=e.entity,n=t.source,(r=n.link)?(a=(""+r[1]).concat(i(r[2],3)).concat(i(r[3],2)),s="http://lis.ly.gov.tw/lgcgi/lypdftxt?"+a+";".concat(i(r[4],4)).concat(";"+i(r[5],4)),o.trustAsHtml('<a href="'+s+'" target="_blank">質詢公報</a>')):""},t.answers=function(e){var t,n,r;return t=e.entity,n=t.answers,r="",angular.forEach(n,function(e){var t,n,o;e.source.text.match(/口頭答復/)||(t=e.source.link,n=(""+t[1]).concat(i(t[2],3)).concat(i(t[3],2)),o="http://lis.ly.gov.tw/lgcgi/lypdftxt?"+n+";".concat(i(t[4],4)).concat(";"+i(t[5],4)),r+='<div><a href="'+o+'" target="_blank">書面答復</a></div>')}),deepEq$(r,"","===")&&(r+="口頭(見質詢公報)"),o.trustAsHtml(r)},t.pagingOptions={pageSizes:[10,20,30],pageSize:30,currentPage:1},t.$watch("pagingOptions",function(e,n){deepEq$(e.pageSize,n.pageSize,"===")&&deepEq$(e.currentPage,n.currentPage,"===")||t.getData(e)},!0),t.gridOptions=import$({showFilter:!0,showColumnMenu:!0,showGroupPanel:!0,enableHighlighting:!0,enableRowSelection:!0,enablePaging:!0,showFooter:!0},{rowHeight:80,data:"debates",pagingOptions:t.pagingOptions,i18n:"zh-tw",columnDefs:[{field:"tts_id",displayName:"系統號",width:80},{field:"mly",displayName:"質詢人",width:130,cellTemplate:'<div ng-bind-html="mly(row)"></div>'},{field:"source",displayName:"質詢公報",width:80,cellTemplate:'<div ng-bind-html="source(row)"></div>'},{field:"answers",displayName:"答復公報",width:100,cellTemplate:'<div ng-bind-html="answers(row)"></div>'},{field:"summary",displayName:"案由",visible:!1},{field:"answered",displayName:"答復",width:"50",cellTemplate:'<div ng-bind-html="answer(row)"></div>'},{field:"date_asked",cellFilter:"date: mediumDate",width:"100",displayName:"質詢日期"},{field:"category",width:"*",displayName:"類別",cellTemplate:'<div ng-repeat="c in row.getProperty(col.field) track by $id($index)"><span class="label">{{c}}</span></div>'},{field:"topic",displayName:"主題",width:"*",cellTemplate:'<div ng-repeat="c in row.getProperty(col.field) track by $id($index)"><span class="label">{{c}}</span></div>'},{field:"keywords",displayName:"關鍵詞",width:"*",cellTemplate:'<div ng-repeat="c in row.getProperty(col.field) track by $id($index)"><span class="label">{{c}}</span></div>'},{field:"answered_by",displayName:"答復人",width:"80",cellTemplate:'<div ng-repeat="c in row.getProperty(col.field) track by $id($index)"><span >{{c}}</span></div>'},{field:"debate_type",displayName:"質詢性質",width:"*"}]}),t.getData=function(e){var r,o;return r=e.currentPage,o=e.pageSize,n.get("http://api.ly.g0v.tw/v0/collections/debates",{params:{sk:(r-1)*o,l:o}}).success(function(e){var n,r;return n=e.paging,r=e.entries,angular.forEach(r,function(e){e.date_asked=new Date(e.date_asked),e.source=JSON.parse(e.source)}),t.debates=r})},t.getData(t.pagingOptions)})});var maketree;maketree=function(e,t,n){var r,o,i,a,s,l,c,u,d,f;return r={top:0,right:40,bottom:0,left:40},o=960-r.right,i=n-r.top-r.bottom,a=d3.layout.tree().size([i,1]).separation(function(){return 1}),a.sort(function(e,t){return+e.name-+t.name}),s=d3.select(e).append("svg").attr("width",o+r.left+r.right).attr("height",i+r.top+r.bottom).style("margin","1em 0 1em "+-r.left+"px"),l=s.append("g").attr("transform","translate("+r.left+","+r.top+")"),c=a.nodes(t),u=d3.scale.linear().range([0,o]),u.domain([d3.min(c,function(e){return+e.name}),d3.max(c,function(e){return+e.name})]),d=l.selectAll(".link").data(a.links(c)).enter().append("path").attr("class","link").attr("d",d3.svg.diagonal().source(function(e){return{y:u(+e.source.name),x:e.source.x}}).target(function(e){return{y:u(+e.target.name),x:e.target.x}}).projection(function(e){return[e.y,e.x]})),f=l.selectAll(".node").data(c).enter().append("g").attr("class",function(e){return(e.type||"")+" node"}).attr("transform",function(e){return"translate("+u(+e.name)+","+e.x+")"}),f.append("text").attr("x",6).attr("dy",".32em").text(function(e){return e.name}).each(function(e){return e.width=this.getComputedTextLength()+12}),f.insert("rect","text").attr("ry",6).attr("rx",6).attr("y",-10).attr("height",20).attr("width",function(e){return Math.max(32,e.width)}),s},window.billHistory=function(e){var t,n,r,o,i,a,s,l,c,u,d;return t={top:20,right:20,bottom:100,left:40},n=960-t.left-t.right,r=500-t.top-t.bottom,o=d3.scale.ordinal().rangeRoundBands([0,n],.1),i=d3.scale.linear().rangeRound([r,0]),a=e.map(function(e){return e.motions.map(function(e){return e.meeting
})}).reduce(curry$(function(e,t){return e.concat(t)})),s=d3.min(a),l=d3.max(a),o.domain(e.map(function(e){return e.motions.map(function(e){return e.meeting})}).reduce(curry$(function(e,t){return e.concat(t)}))),c=d3.svg.axis().scale(o).orient("bottom"),u=function(e,t,n){var r,o,i,a,s,l,c,d,f,p,g,h=[];if(o=function(){var e,o,i,a=[];for(e=0,i=(o=t).length;i>e;++e)r=o[e],r.id===n&&a.push(r);return a}()[0],null!=o){for(i=e,a=0,l=(s=o.motions).length;l>a;++a)c=s[a],d={name:c.meeting,bill:o,"class":"motion",children:[],type:"text"},console.log("push",i,d),i.children.push(d),i=d;for(a=0,l=(s=null!=(f=o.related)?f:[]).length;l>a;++a)p=s[a],h.push(g=u(i,t,p));return h}},d={name:17,"class":"root",children:[]},u(d,e,e[0].id),u(d,e,e[0].id),console.log(d),maketree(".history",d,360)};var stackedBars;window.loadMotions=function(e){return $(function(){return d3.json("/data/8-2.json",function(t){var n;return n=t.map(function(e){var t,n,r,o,i,a,s,l,c,u,d,f;for(t=e.meeting,n=e.announcement,r=e.discussion,o=function(){return d3.nest().key(function(e){var t;return null!=(t=e.status)?t:"unknown"}).rollup(function(e){return e.length})},a=[],s=0,l=r.length;l>s;++s)c=r[s],"exmotion"===c.type&&a.push(c);for(i=a,a=[],s=0,l=r.length;l>s;++s)c=r[s],"exmotion"!==c.type&&a.push(c);return r=a,u=o().map(n),d=o().map(r),f=o().map(i),{sitting:t.sitting,ann:n.length,dis:null!=r?r.length:void 0,ann_status:u,dis_status:d,exm_status:f,announcement:n,discussion:r,exmotion:i,meeting:t}}),e.$root.$broadcast("data",n),stackedBars(n,e)})})},stackedBars=function(e,t){var n,r,o,i,a,s,l,c,u,d,f,p,g,h,m,v,b,y,w,x,C;return n={top:10,right:20,bottom:10,left:60},r=1600,o=600,i=d3.scale.ordinal().rangeRoundBands([0,r],.1),a=d3.scale.linear().rangeRound([o,0]),s=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),l=d3.svg.axis().scale(i).orient("bottom"),c=d3.svg.axis().scale(a).orient("left").tickFormat(d3.format(".2s")),u=r+n.left+n.right,d=o+n.top+n.bottom,f="0 0 "+u+" "+d,p=d3.select(".chart").append("svg").attr("width","100%").attr("height","80%").attr("viewBox",f).append("g").attr("transform","translate("+n.left+","+n.top+")"),g=200,h=800,m=d3.select(".legends").append("svg").attr("width","100%").attr("height","80%").attr("viewbox","0 0 "+g+" "+h),v=d3.scale.ordinal().range(["#cccccc","#8a89a6","#7b6888","#6b486b","#ff8c00","#ff1c00","#000000","#23ff8c","#6b486b","#dddddd","#dddddd"]).domain(["retrected","rejected","accepted","committee","prioritized","unhandled","consultation","passed","ey","other","unknown"]),s.domain(["ann","dis"]),e.forEach(function(e){var t,n;return t=0,e.cum=s.domain().map(function(n){return{name:n,y0:t,y1:t+=+e[n]}}),t=0,e.ann_cum=v.domain().map(function(n){var r;return{name:n,y0:t,y1:t+=+(null!=(r=e.ann_status[n])?r:0)}}),t=0,e.dis_cum=v.domain().map(function(n){var r;return{name:n,y0:t,y1:t+=+(null!=(r=e.dis_status[n])?r:0)}}),t=0,e.exm_cum=v.domain().map(function(n){var r;return{name:n,y0:t,y1:t+=+(null!=(r=e.exm_status[n])?r:0)}}),e.total=(n=e.cum)[n.length-1].y1}),i.domain(e.map(function(e){return e.sitting})),a.domain([0,d3.max(e,function(e){return e.total})]),b=function(e,n,r){return t.$root.$broadcast("show",r,e,n)},p.append("g").attr("class","x axis").attr("transform","translate(0,"+o+")").call(l),y=p.selectAll(".sitting").data(e).enter().append("g").attr("class","g").attr("transform",function(e){return"translate("+i(e.sitting)+",0)"}).on("click",function(e){return b("announcement",e.name,x)}),w=p.append("g").selectAll(".desc").data(["報告事項","討論事項","臨時提案"]).enter().append("text").attr("class","desc").attr("transform",function(e,t){return"rotate(-90)translate("+(-o-10)+","+(i.rangeBand()*t/3+i(5))+")"}).attr("dy",".71em").style("text-anchor","end").text(function(e){return e}),x=null,y.selectAll("rect.sep").data(function(e){return[e.sitting]}).enter().append("rect").attr("class","sep").attr("width",1).attr("y",0).attr("x",i.rangeBand()+3).attr("height",o).style("fill","none").style("stroke","black").style("stroke-width",1).style("opacity",.2),y.selectAll("rect.col").data(function(e){return[e.sitting]}).enter().append("rect").attr("class","col").attr("width",i.rangeBand()).attr("y",0).attr("height",o).style("fill","white").style("opacity",0).on("mouseover",function(e){return e!==x?(w.attr("transform",function(t,n){return"rotate(-90)translate("+(-o-20)+","+(i.rangeBand()*n/3+i(e))+")"}),x=e):void 0}),y.selectAll("rect.ann").data(function(e){return e.ann_cum}).enter().append("rect").attr("class","ann").attr("width",i.rangeBand()/3-2).attr("y",function(e){return a(e.y1)}).attr("height",function(e){return a(e.y0)-a(e.y1)}).style("fill",function(e){return v(e.name)}),y.selectAll("rect.dis").data(function(e){return e.dis_cum}).enter().append("rect").attr("class","dis").attr("width",i.rangeBand()/3-2).attr("x",function(){return i.rangeBand()/3+1}).attr("y",function(e){return a(e.y1)}).attr("height",function(e){return a(e.y0)-a(e.y1)}).style("fill",function(e){return v(e.name)}),y.selectAll("rect.exm").data(function(e){return e.exm_cum}).enter().append("rect").attr("class","exm").attr("width",i.rangeBand()/3-2).attr("x",function(){return 2*(i.rangeBand()/3)+1}).attr("y",function(e){return a(e.y1)}).attr("height",function(e){return a(e.y0)-a(e.y1)}).style("fill",function(e){return v(e.name)}),C=m.selectAll(".legend").data(v.domain().slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(0,"+20*t+")"}),C.append("rect").attr("x",0).attr("width",18).attr("height",18).style("fill",v),C.append("text").attr("x",20).attr("y",9).attr("dy",".35em").text(function(e){return t.statusName(e)}),p.append("g").attr("class","y axis").call(c).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("議案數")},angular.module("utils",[]).controller("topBtnCtrl",["$scope","$window"].concat(function(e,t){return e.showBtn=!1,angular.element(t).bind("scroll",function(){return console.log(window.pageYOffset),e.showBtn=window.pageYOffset>500?!0:!1,e.$apply()}),e.jumpToTop=function(){return window.scrollTo(0,0)}})),angular.module("app.controllers.search",[]).controller({LYSearch:["$rootScope","$scope","$state","$timeout","LYModel"].concat(function(e,t,n,r,o){var i;return t.limit=12,t.sk=0,t.results=[],t.$watch("$state.params.keyword",function(){return t.sk=0,t.keyword=n.params.keyword,n.params.keyword?o.get("laws",{params:{q:JSON.stringify({name:{$matches:n.params.keyword}}),f:JSON.stringify({id:1}),fo:!0}}).success(function(e){var n;return n=e.id,t.lawId=n,t.results=[],t.moreResults()}):void 0}),t.moreResults=function(){return t.busy=!0,i(t.lawId,function(e){function n(e){return t.results.push(e)}var r,i,a;for(r=0,i=e.length;i>r;++r)a=e[r],o.get("bills/"+a.bill_ref).success(n);return 0===e.length&&(t.stopDetect=!0),t.busy=!1})},i=function(e,n){return o.get("amendments",{params:{q:JSON.stringify({law_id:e}),f:JSON.stringify({bill_ref:1}),l:t.limit,sk:t.sk}}).success(function(e){var r,o;return r=e.paging,o=e.entries,t.sk+=t.limit,n(o)})}})});var replace$="".replace;angular.module("app.controllers.sittings",[]).controller({LYSittings:["$rootScope","$scope","$http","$state","LYService","LYModel"].concat(function(e,t,n,r,o,i){var a,s,l,c,u;return e.activeTab="sittings",a=e.committees,t.lists={},window.YT?t.youtubeReady=!0:t.$on("youtube-ready",function(){return t.youtubeReady=!0}),t.setContext=function(e){return t.context=e,r.params.sitting=null},t.$watch("$state.params.sitting",function(){var e;return(e=r.params.sitting)?(t.sitting_id=e,console.log("specified sitting, get context from id of sitting"),t.context=replace$.call(e,/[\d-]/g,""),l(e)):(console.log("no specified sitting, use YS as default context if necessary"),t.context||(t.context="YS"))}),t.$watch("context",function(e,n){return e||n?(console.log("current context is ",t.context),t.lists.hasOwnProperty(t.context)?t.currentList=t.lists[t.context]:(console.log("using context that we do not have yet. fetch it "),s())):void 0}),s=function(e){var n;return n=a[t.context]?'{"'+t.context+'"}':null,e||(e=40),t.loadingList=!0,i.get("sittings",{params:{q:{ad:8,committee:n},l:e,f:{motions:!1,videos:!1}}}).success(function(e){var n;return n=e.entries,t.loadingList=!1,t.lists[t.context]=n,t.currentList=t.lists[t.context]})},t.$watch("currentList",function(){var e,n,o,i,a;if(t.currentList)return e=null!=(n=function(){var e,n,a,s=[];for(e=0,a=(n=t.currentList).length;a>e;++e)o=n[e],i=o.id,i===r.params.sitting&&s.push(o);return s}())?n[0]:void 0,e?t.chosenSitting=e:(a=r.params.sitting,a?(console.log("user specified a id out of fetched list, use the i and keep drop-down list blank"),l(a)):(console.log("user move to a new context, use the lastest sitting by default"),t.chosenSitting=t.currentList[0]))}),t.$watch("chosenSitting",function(e){var n;if(e)return n=t.chosenSitting.id,l(t.chosenSitting.id)}),l=function(e){var n;return n=/^sittings.detail/.exec(r.current.name)?r.current.name:"sittings.detail",r.transitionTo(n,{sitting:e}),t.loadingSitting=!0,i.get("sittings/"+e).success(function(n){return t.loadingSitting=!1,import$(t,n),t.data=[],t.data.announcement=c(n.motions,"announcement"),t.data.discussion=c(n.motions,"discussion"),t.data.exmotion=c(n.motions,"exmotion"),t.setType("announcement"),i.get("sittings/"+e+"/videos").success(function(e){return t.videos=e})})},c=function(e,t){var n;return function(){var r,o,i,a=[];for(r=0,i=(o=e).length;i>r;++r)n=o[r],n.motion_class===t&&a.push(n);return a}()},import$(t,{allTypes:[{key:"announcement",value:"報告事項"},{key:"discussion",value:"討論事項"},{key:"exmotion",value:"臨時提案"}],setType:function(e){var n,r,i,a,s,l,c,u,d;for(n=t.data[e],r=[{key:"all",value:"全部"}].concat(function(){function e(){var e,t,r,o,i={};for(e=0,r=(t=n).length;r>e;++e)a=t[e],i[null!=(o=a.status)?o:"unknown"]=!0;return i}var r=[];for(i in e())r.push({key:i,value:t.statusName(i)});return r}()),in$(t.status,r.map(function(e){return e.key}))||(t.status=""),s=0,l=n.length;l>s;++s)if(a=n[s],null==a.avatars)switch(c=[a.proposed_by],!1){case!(u=/委員(.*?)(、|等)/.exec(c[0])):d=o.resolveParty(u[1]),a.avatars=[{party:d,name:u[1],avatar:""+CryptoJS.MD5("MLY/"+u[1])}];break;case!(u=/本院(.*黨團)/.exec(c[0])):d=o.parseParty(replace$.call(u[1],/黨團$/,"")),a.avatars=[{party:d,name:u[1],iconClass:d}]}return t.type=e,t.entries=n,t.allStatus=r,t},setStatus:function(e){return"all"===e&&(e=""),"unknown"===e&&(e=""),t.status=e},statusName:function(e){var t,n;return t={unknown:"未知",other:"其他",passed:"通過",consultation:"協商",retrected:"撤回",unhandled:"未處理",ey:"請行政院研處",prioritized:"逕付二讀",committee:"交委員會",rejected:"退回",accepted:"查照"},null!=(n=t[e])?n:e}}),t.playFrom=function(e){return-1===t.player.getPlayerState()?(t.player.playVideo(),t.player.nextStart=e):t.player.seekTo(e)},t.$watch("$state.current.name + $state.params.sitting",function(){var e;if("sittings.detail.video"===r.current.name){if(t.video=!0,t.loaded===r.params.sitting)return;return t.loaded=r.params.sitting,u=t.$watch("$location.hash()",function(t){return t?e=moment(t+"+08:00"):void 0}),getVideosByCut(i,r.params.sitting,function(r){var o,i,a,s,l,c,u,d,f;if(e)for(o=0,i=r.length;i>o;++o)a=r[o],e>=a.first_frame&&a.first_frame+1e3*a.length>=e&&(t.currentVideo=a);return null==t.currentVideo&&(t.currentVideo=r[0]),s=!1,l=function(n){var r;return t.player=n.target,e?(r=t.currentVideo.first_frame,t.player.nextStart=(e-r)/1e3,t.player.playVideo(),e=null,$("#player").get(0).scrollIntoView()):void 0},c=null,u=function(e){var n,r,o,i;e.data!==YT.PlayerState.PLAYING||s?(c&&clearInterval(c),c=null):((n=t.player.nextStart)&&(setTimeout(function(){return t.player.seekTo(n)},50),t.player.nextStart=null),c&&clearInterval(c),r=o={},r.sec=t.player.getCurrentTime(),r.start=(new Date).getTime()/1e3,r.rate=t.player.getPlaybackRate(),r.now=0,i=function(){return o.now=(new Date).getTime()/1e3,t.$apply(function(){var e,n,r,i,a=[];for(e=0,r=(n=t.waveforms).length;r>e;++e)i=n[e],i.id===t.currentId&&a.push(i.current=o.sec+(o.now-o.start)*o.rate);return a})},c=setInterval(function(){return i()},1e4),i())},t.player?t.player.loadVideoById({videoId:t.currentVideo.youtube_id}):(d=function(){var n,r;return e&&(n=t.currentVideo.first_frame,r=(e-n)/1e3),new YT.Player("player",{height:"390",width:"640",videoId:t.currentVideo.youtube_id,playerVars:{rel:0,start:null!=r?r:0,modestbranding:1},events:{onReady:l,onStateChange:u}})},t.youtubeReady?d():t.$on("youtube-ready",function(){return d()})),t.waveforms=[],t.currentId=t.currentVideo.youtube_id,f=function(n,o,i,a,s){var l,c,u,d,f;for(l=[],c=0,u=n.length;u>c;++c)d=c,f=n[c],n[d]=f/255;return t.waveforms[s]={index:s,id:r[s].youtube_id,wave:n,speakers:o,current:0,start:i,time:a,cb:function(n){var o,i;return t.currentId!==this.id&&(t.currentWaveform=this,t.player.loadVideoById(this.id),e=null,t.currentId=this.id,t.currentVideo=function(){var e,t,n,i=[];for(e=0,n=(t=r).length;n>e;++e)o=t[e],o.youtube_id===this.id&&i.push(o);return i}.call(this)[0]),null!=(i=t.player)&&(i.nextStart=n),t.playFrom(n)}}},r.forEach(function(e,t){n.get("http://kcwu.csie.org/~kcwu/tmp/ivod/waveform/"+e.wmvid+".json").error(function(){return f([],e.speakers,e.first_frame,e.time,t)}).success(function(n){return f(n,e.speakers,e.first_frame,e.time,t)})})})}return t.loaded=null,t.video=null,"function"==typeof u?u():void 0})})});var ctemplate,renderConversation,render,renderYs,slice$=[].slice;ctemplate=require("view/ys/conversation"),renderConversation=function(e){return ctemplate({conversation:e,renderConversation:renderConversation})},render=function(e,t,n){var r,o,i,a,s,l,c=[];switch(t){case"Announcement":return e.append(require("view/ys/announcement")({content:n,renderConversation:renderConversation})),$(".sidebarnav").append($("<ul><li><a href='#announcement'>報告事項</a><li/></ul>").html());case"Interpellation":for(e.append(require("view/ys/interpellation")({content:n,renderConversation:renderConversation})),$(".sidebarnav").append($("<ul><li><a href='#interpellation'>質詢事項</a><li/></ul>").html()),r=0,i=(o=n.interpellation).length;i>r;++r)a=o[r],t=a[0],s=a[1],"interp"===t&&(l=s[0][0],c.push($(".sidebarnav").append($("<ul><li><a scrollto href='#interpellation-"+l+"'>"+l+"</a><li/></ul>").html())));return c;default:return e.append(renderConversation({conversation:[t,n]}))}},renderYs=function(e,t){var n,r,o,i,a,s;for(n=t.meta,r=t.log,e.append(require("view/ys/meta")(n)),o=0,i=r.length;i>o;++o)a=r[o],render.apply(null,[e].concat(slice$.call(a)));return $('[data-spy="affix"]').affix(),s=function(){return $('[data-spy="scroll"]').each(function(){return $(this).scrollspy("refresh")})},$(".collapse").on("hidden",s),s()},window.init=function(){return $.get("/data/yslog/ly-4004.json",{type:"json"},function(e){return renderYs($(".content"),e)})};var committees,renderCommittee;committees={IAD:"內政",FND:"外交及國防",ECO:"經濟",FIN:"財政",EDU:"教育及文化",TRA:"交通",JUD:"司法及法制",SWE:"社會福利及衛生環境",PRO:"程序"},renderCommittee=function(e){var t,n,r,o,i;if(null==e)return"院會";if("null"===e)return"院會";for($.isArray(e)||(e=[e]),n=[],r=0,o=e.length;o>r;++r)i=e[r],n.push('<img class="avatar small" src="http://avatars.io/50a65bb26e293122b0000073/committee-'+i+'?size=small" alt="'+committees[i]+'">'+committees[i]);return t=n,t.join("")},angular.module("app.controllers",["app.controllers.calendar","app.controllers.sittings","app.controllers.bills","app.controllers.search","ng"]).run(["$rootScope"].concat(function(e){return e.committees=committees})).controller({AppCtrl:["$scope","$location","$rootScope","$sce"].concat(function(e,t){return e.$location=t,e.$watch("$location.path()",function(t){return t||(t="/"),e.activeNavId=t,e}),e.getClass=function(t){return e.activeNavId.substring(0,t.length===t)?"active":""}})}).filter("committee",["$sce"].concat(function(e){return function(t){return e.trustAsHtml(renderCommittee(t))}})).controller({SearchFormCtrl:["$scope","$state"].concat(function(e,t){return e.submitSearch=function(){return t.transitionTo("search.target",{keyword:e.searchKeyword}),e.searchKeyword=""}})}).controller({About:["$rootScope","$http"].concat(function(e){return e.activeTab="about"})}).controller({LYMotions:["$rootScope","$scope","$state","LYService"].concat(function(e,t,n,r){return e.activeTab="motions",t.session="8-2",t.$on("data",function(e,n){return t.$apply(function(){return t.data=n})}),t.$watch("$state.params.sitting",function(){var e;return(e=n.params.sitting)?t.$watch("data",function(n){return n?(t.sitting=+e,t.setType("announcement"),t.setStatus(null)):void 0}):(t.sitting=null,void 0)}),t.$on("show",function(e,r,o,i){return t.$apply(function(){return n.transitionTo("motions.sitting",{session:t.session,sitting:r}),t.sitting=r,t.status=i,t.setType(o),t.setStatus(i)})}),import$(t,{allTypes:[{key:"announcement",value:"報告事項"},{key:"discussion",value:"討論事項"},{key:"exmotion",value:"臨時提案"}],setType:function(e){var n,o,i,a,s,l,c,u,d,f,p;for(o=function(){var e,r,o,i=[];for(e=0,o=(r=t.data).length;o>e;++e)n=r[e],n.meeting.sitting===t.sitting&&i.push(n);return i}()[0],i=o[e],a=[{key:"all",value:"全部"}].concat(function(){function e(){var e,t,n,r,o={};for(e=0,n=(t=i).length;n>e;++e)l=t[e],o[null!=(r=l.status)?r:"unknown"]=!0;return o}var n=[];for(s in e())n.push({key:s,value:t.statusName(s)});return n}()),in$(t.status,a.map(function(e){return e.key}))||(t.status=""),c=0,u=i.length;u>c;++c)l=i[c],null==l.avatars&&(d=null!=(f=l.proposer)?f.match(/委員(.*?)(、|等)/):void 0)&&(p=r.resolveParty(d[1]),l.avatars=[{party:p,name:d[1],avatar:""+CryptoJS.MD5("MLY/"+d[1])}]);return t.type=e,t.entries=i,t.allStatus=a,t},setStatus:function(e){return"all"===e&&(e=""),"unknown"===e&&(e=""),t.status=e},statusName:function(e){var t,n;return t={unknown:"未知",other:"其他",passed:"通過",consultation:"協商",retrected:"撤回",unhandled:"未處理",ey:"請行政院研處",prioritized:"逕付二讀",committee:"交委員會",rejected:"退回",accepted:"查照"},null!=(n=t[e])?n:e}}),window.loadMotions(t)})}).controller({LYSitting:["$rootScope","$scope","$http"].concat(function(e,t,n){return n.get("/data/yslog/ly-4004.json").success(function(n){var r,o,i,a,s,l,c=[];for(e.activeTab="sitting",t.json=n,t.meta=n.meta,t.meta.map=[],r={"立法院公報":/^立法院公報　/,"主席":/^主　+席　/,"時間":/^時　+間　/,"地點":/^地　+點　/},n.meta.raw.forEach(function(e){var t,o,i,a;for(t in o=r){if(i=o[t],e.match(i)){e=e.replace(i,""),a=t;break}a=""}return n.meta.map.push({key:a,value:e})}),t.annoucement=[],t.interpellation={answers:[],questions:[],interpellations:[]},t.interp=[],o=function(e,n){var r,o,i,a,s,l,c,u,d,f,p,g,h,m,v,b,y=[];switch(e){case"Announcement":t.Announcement=n;for(r in n){for(o=n[r],i={subject:o.subject,conversation:[]},a=0,l=(s=o.conversation).length;l>a;++a)c=s[a],u=c[0],d=c[1],i.conversation.push({speaker:u,words:d});y.push(t.annoucement.push(i))}return y;case"Interpellation":for(f in s=n.answers)c=s[f],p=c[0],d=c[1],t.interpellation.answers.push({receiver:p,words:d});for(f in s=n.questions)c=s[f],g=c[0],d=c[1],t.interpellation.questions.push({asker:g,words:d});for(a=0,l=(s=n.interpellation).length;l>a;++a)c=s[a],e=c[0],h=c[1],"interp"===e&&t.interp.push(h);for(a=0,l=(s=n.interpellation).length;l>a;++a){if(c=s[a],e=c[0],h=c[1],m=[],"interp"===e||"interpdoc"===e||"exmotion"===e)for(i={questioner:h[0][0],conversation:[]},v=0,b=h.length;b>v;++v)c=h[v],u=c[0],d=c[1],i.conversation.push({speaker:u,words:d});else i={questioner:null,conversation:[{speaker:e,words:h}]};m.push(t.interpellation.interpellations.push(i)),y.push(m)}return y;default:return t.otherwise=n}},i=0,s=(a=n.log).length;s>i;++i)l=a[i],c.push(o.apply(null,l));return c})})});